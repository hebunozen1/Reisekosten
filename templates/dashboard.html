<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>لوحة الرحلة</title>
  <style>
    body{font-family:Arial;background:#f5f5f5;margin:0;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;padding:14px 16px;box-shadow:0 2px 12px rgba(0,0,0,.06);min-width:220px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .big{font-size:22px;font-weight:800}
    .muted{color:#666;font-size:13px}
    .wrap{background:#fff;border-radius:12px;padding:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);margin-top:14px}
    label{font-weight:800;display:block;margin:10px 0 6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
    textarea{resize:vertical}
    button{padding:11px 14px;border:0;border-radius:10px;background:#2c7be5;color:#fff;font-weight:800;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid #eee;padding:10px;vertical-align:top}
    th{background:#fafafa;text-align:right;position:sticky;top:0}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
    .ok{background:#e6ffed}
    .no{background:#fff5f5}
    a{text-decoration:none}
    .msg{padding:10px;border-radius:10px;margin:10px 0}
    .msg.ok{background:#e6ffed}
    .msg.err{background:#fff5f5}
  </style>
</head>
<body>

<div class="top">
  <div>
    <div class="big">مرحبًا {{ username }}</div>
    <div class="muted">أدخل مصروفاتك، وسترى الرصيد المتبقي أو إذا كنت في العجز</div>
  </div>
  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-start">
    <form method="post" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0">
      <input type="hidden" name="action" value="set_start">
      <input name="startguthaben_sar" inputmode="decimal" placeholder="المبلغ المستلم (SAR)" value="{{ "%.2f"|format(start) }}" style="width:170px;padding:10px;border:1px solid #ddd;border-radius:10px">
      <button type="submit">حفظ</button>
    </form>
    <form method="post" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0">
      <input type="hidden" name="action" value="reset_start">
      <button type="submit" style="background:#eee;color:#111">إعادة ضبط</button>
    </form>
    <a href="{{ url_for('logout') }}">تسجيل الخروج</a>
  </div>
</div>

<div class="grid">
  <div class="card">
    <div class="muted">الرصيد الابتدائي (SAR)</div>
    <div class="big">{{ "%.2f"|format(start) }}</div>
  </div>
  <div class="card">
    <div class="muted">إجمالي المصروفات (SAR)</div>
    <div class="big">{{ "%.2f"|format(total) }}</div>
  </div>
  <div class="card">
    <div class="muted">الرصيد الحالي (SAR)</div>
    <div class="big">
      {{ "%.2f"|format(saldo) }}
      {% if saldo >= 0 %}
        <span class="badge ok">متبقي</span>
      {% else %}
        <span class="badge no">من جيبك</span>
      {% endif %}
    </div>
  </div>
</div>

<div class="wrap">
  <h3 style="margin-top:0">إضافة مصروف</h3>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat,msg in messages %}
        <div class="msg {{ 'ok' if cat=='ok' else 'err' }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" enctype="multipart/form-data">
    <label>التاريخ</label>
    <input type="date" name="datum" required>

    <label>الفئة</label>
    <select name="kategorie" required>
      <option value="" disabled selected>اختر الفئة</option>
      {% for code, v in kategorien %}
        <option value="{{code}}">{{ v.ar }}</option>
      {% endfor %}
    </select>

    <label>وصف المصروف</label>
    <textarea name="beschreibung_ar" rows="4" placeholder="مثال: دفع تكاليف نقل المجموعة" required></textarea>

    <label>المبلغ (SAR)</label>
    <input type="number" step="0.01" name="betrag_sar" placeholder="مثال: 250" required>

    <label>رفع الإيصال</label>
    <input type="file" name="beleg" accept="image/*,application/pdf">

    <button type="submit">حفظ</button>
  </form>
</div>

<div class="wrap">
  <h3 style="margin-top:0">مصروفاتي</h3>
  <div class="muted" style="margin-bottom:10px">آخر الإدخالات تظهر بالأعلى</div>

  <div style="overflow:auto">
  <table>
    <tr>
      <th>التاريخ</th>
      <th>الفئة</th>
      <th>الوصف</th>
      <th>SAR</th>
      <th>الحالة</th>
      <th>إجراءات</th>
    </tr>
    {% for r in rows %}
    <tr>
      <td>{{ r["datum"] }}</td>
      <td>{{ r["kategorie_ar"] }}</td>
      <td>{{ r["beschreibung_ar"] }}</td>
      <td>{{ "%.2f"|format(r["betrag_sar"]) }}</td>
      <td>
        {% if r["genehmigt"] %}
          <span class="badge ok">موافق</span>
        {% else %}
          <span class="badge no">قيد المراجعة</span>
        {% endif %}
      </td>
      <td>
        {% if not r["genehmigt"] %}
          <form method="post" style="margin:0">
            <input type="hidden" name="action" value="delete_kosten">
            <input type="hidden" name="kid" value="{{ r['id'] }}">
            <button type="submit" onclick="return confirm('حذف هذا الإدخال؟');" style="background:#fff5f5;color:#b00020;border:1px solid #f0c2c2;border-radius:10px;padding:6px 10px;cursor:pointer">حذف</button>
          </form>
        {% else %}
          <span class="muted">—</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </table>
  </div>
</div>

</body>
</html>
