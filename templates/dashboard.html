<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø­Ù„Ø©</title>
  <style>
    body{font-family:Arial;background:#f5f5f5;margin:0;padding:18px}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;padding:14px 16px;box-shadow:0 2px 12px rgba(0,0,0,.06);min-width:220px}
    .grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .big{font-size:22px;font-weight:800}
    .muted{color:#666;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:12px;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,.06)}
    th,td{border-bottom:1px solid #eee;padding:10px;vertical-align:top}
    th{background:#fafafa;text-align:right}
    input,select{padding:10px;border:1px solid #ddd;border-radius:10px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#0c7be5;color:#fff;font-weight:700;cursor:pointer}
    .danger{background:#ff4d4f}
    a{text-decoration:none}
    .msg{padding:10px;border-radius:10px;margin:10px 0}
    .msg.ok{background:#e6ffed}
    .msg.err{background:#fff5f5}
    .badge{padding:3px 8px;border-radius:999px;font-size:12px;display:inline-block}
    .b-ok{background:#e6ffed}
    .b-no{background:#fff5f5}
    .b-wait{background:#fffbe6}
  </style>
</head>
<body>

<div class="top">
  <div>
    <div class="muted">Ù…Ø±Ø­Ø¨Ù‹Ø§</div>
    <div class="big">{{ session.get('username') }}</div>
  </div>

  <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
    <form method="post" enctype="multipart/form-data" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:0">
      <input type="hidden" name="action" value="set_start">
      <input name="startguthaben_sar" inputmode="decimal" placeholder="Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ (SAR)" value="{{ '%.2f'|format(start) }}" style="width:190px">
      <input type="file" name="wechselkurs_beleg" accept="image/*" capture="environment" style="width:220px">
      <button type="submit">Ø­ÙØ¸</button>
    </form>
    <form method="post" style="margin:0">
      <input type="hidden" name="action" value="reset_start">
      <button type="submit" style="background:#777">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button>
    </form>

    {% if wechselkurs_beleg %}
      <a href="/uploads/{{ wechselkurs_beleg }}" target="_blank" class="muted">ğŸ“ Ø¥ÙŠØµØ§Ù„ Ø³Ø¹Ø± Ø§Ù„ØµØ±Ù</a>
    {% endif %}

    <a href="/logout" class="muted">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
  </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for cat,msg in messages %}
      <div class="msg {{ 'ok' if cat=='ok' else 'err' }}">{{ msg }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}

<div class="grid">
  <div class="card">
    <div class="muted">(SAR) Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</div>
    <div class="big">{{ '%.2f'|format(start) }}</div>
  </div>
  <div class="card">
    <div class="muted">(SAR) Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</div>
    <div class="big">{{ '%.2f'|format(total) }}</div>
  </div>
  <div class="card">
    <div class="muted">(SAR) Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
    <div class="big">{{ '%.2f'|format(saldo) }}</div>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <h3 style="margin:0 0 10px">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
  <form method="post" enctype="multipart/form-data" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:end">
    <input type="hidden" name="action" value="add_kosten">

    <div>
      <div class="muted">Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
      <input type="date" name="datum" value="{{ today }}" required style="width:100%">
    </div>

    <div>
      <div class="muted">Ø§Ù„ÙØ¦Ø©</div>
      <select name="kategorie" required style="width:100%">
        {% for code, obj in ordered %}
          <option value="{{ code }}">{{ obj['ar'] }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="grid-column:1/-1">
      <div class="muted">Ø§Ù„ÙˆØµÙ</div>
      <input name="beschreibung_ar" required style="width:100%">
    </div>

    <div>
      <div class="muted">Ø§Ù„Ù…Ø¨Ù„Øº (SAR)</div>
      <input name="betrag_sar" inputmode="decimal" required style="width:100%">
    </div>

    <div>
      <div class="muted">Ø¥ÙŠØµØ§Ù„ / ØµÙˆØ±Ø©</div>
      <input id="belegInput" type="file" name="beleg" accept="image/*" capture="environment" style="width:100%">
      <label style="display:flex;gap:8px;align-items:center;margin-top:6px;font-size:13px">
        <input id="ohneBelegCheck" type="checkbox" name="ohne_beleg" style="width:auto"> Ø¨Ø¯ÙˆÙ† Ø¥ÙŠØµØ§Ù„
      </label>
    </div>

    <div style="grid-column:1/-1">
      <button type="submit" style="width:100%">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    </div>
  </form>
</div>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø§Ù„ÙØ¦Ø©</th>
      <th>Ø§Ù„ÙˆØµÙ</th>
      <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
      <th>Ø§Ù„Ø¥ÙŠØµØ§Ù„</th>
      <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
    </tr>
  </thead>
  <tbody>
    {% for r in rows %}
      <tr>
        <td>{{ r["datum"] }}</td>
        <td>{{ r["kategorie_ar"] }}</td>
        <td>{{ r["beschreibung_ar"] }}</td>
        <td>{{ '%.2f'|format(r["betrag_sar"]) }} SAR</td>
        <td>
          {% if r["beleg"] %}
            <a href="/uploads/{{ r['beleg'] }}" target="_blank">ğŸ“</a>
          {% elif r["ohne_beleg"] %}
            <span class="muted">Ø¨Ø¯ÙˆÙ† Ø¥ÙŠØµØ§Ù„</span>
          {% else %}
            â€”
          {% endif %}
        </td>
        <td>
          {% if r["genehmigt"] == 1 %}
            <span class="badge b-ok">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>
          {% elif r["genehmigt"] == -1 %}
            <span class="badge b-no">ØªÙ… Ø§Ù„Ø±ÙØ¶ (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø¨Ù„Øº)</span>{% if r["rejection_reason"] %}<div class="muted" style="margin-top:4px">Ø§Ù„Ø³Ø¨Ø¨: {{ r["rejection_reason"] }}</div>{% endif %}
          {% else %}
            <span class="badge b-wait">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>
          {% endif %}
        </td>
        <td>
          {% if r["genehmigt"] == 0 %}
            <form method="post" style="margin:0">
              <input type="hidden" name="action" value="delete_kosten">
              <input type="hidden" name="kid" value="{{ r['id'] }}">
              <button type="submit" class="danger">Ø­Ø°Ù</button>
            </form>
          {% else %}
            â€”
          {% endif %}
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>


<script>
(function(){
  const file = document.getElementById('belegInput');
  const chk  = document.getElementById('ohneBelegCheck');
  const form = file && file.closest('form');

  function validate(){
    const hasFile = file && file.files && file.files.length > 0;
    const noRec   = chk && chk.checked;
    // exactly one is required: allow file OR checkbox
    if (!hasFile && !noRec){
      file.setCustomValidity('Bitte Beleg hochladen oder Ø¨Ø¯ÙˆÙ† Ø¥ÙŠØµØ§Ù„ auswÃ¤hlen.');
    } else {
      file.setCustomValidity('');
    }
    // if file chosen, uncheck checkbox
    if (hasFile && chk) chk.checked = false;
  }

  if (file) file.addEventListener('change', validate);
  if (chk) chk.addEventListener('change', validate);
  if (form) form.addEventListener('submit', validate);
})();
</script>

</body>
</html>